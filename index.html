/**
 * Cloud Functions for Firebase - Push Notifications
 * Version: 1.0.1 (Fixed for Firebase Functions v2)
 * 
 * תפקידן:
 * 1. כשלקוחה יוצרת תור חדש → שולחות התראה לבעלת העסק
 * 2. כשבעלת העסק מאשרת תור → שולחות התראה ללקוחה (עתידי)
 */

const {onDocumentCreated, onDocumentUpdated} = require('firebase-functions/v2/firestore');
const {initializeApp} = require('firebase-admin/app');
const {getFirestore} = require('firebase-admin/firestore');
const {getMessaging} = require('firebase-admin/messaging');

// Initialize Firebase Admin
initializeApp();

/**
 * Cloud Function: נשלח כש-תור חדש נוצר
 * Trigger: onCreate בקולקציה appointments
 */
exports.onNewAppointment = onDocumentCreated('appointments/{appointmentId}', async (event) => {
    try {
        const snapshot = event.data;
        if (!snapshot) {
            console.log('No data associated with the event');
            return;
        }

        const appointment = snapshot.data();
        const appointmentId = event.params.appointmentId;

        console.log('New appointment created:', appointmentId, appointment);

        // בדיקה שהתור ממתין לאישור
        if (appointment.status !== 'pending') {
            console.log('Appointment not pending, skipping notification');
            return;
        }

        // שליפת כל הטוקנים של בעלת העסק
        const db = getFirestore();
        const tokensSnapshot = await db
            .collection('fcmTokens')
            .where('isOwner', '==', true)
            .get();

        if (tokensSnapshot.empty) {
            console.log('No owner tokens found');
            return;
        }

        // יצירת רשימת טוקנים
        const tokens = [];
        tokensSnapshot.forEach(doc => {
            tokens.push(doc.data().token);
        });

        console.log(`Found ${tokens.length} owner token(s)`);

        // יצירת הודעת ההתראה
        const message = {
            notification: {
                title: '🔔 תור חדש ממתין!',
                body: `${appointment.name} מבקשת ${appointment.treatment} ב-${formatDate(appointment.date)} בשעה ${appointment.time}`
            },
            data: {
                appointmentId: appointmentId,
                type: 'new_appointment',
                date: appointment.date,
                time: appointment.time,
                customerName: appointment.name
            }
        };

        // שליחת ההתראה לכל הטוקנים
        const messaging = getMessaging();
        const sendPromises = tokens.map(token => {
            return messaging.send({
                ...message,
                token: token
            }).catch(async (error) => {
                console.error('Error sending to token:', token, error);
                // אם הטוקן לא תקף, נמחק אותו
                if (error.code === 'messaging/invalid-registration-token' ||
                    error.code === 'messaging/registration-token-not-registered') {
                    const snapshot = await db
                        .collection('fcmTokens')
                        .where('token', '==', token)
                        .get();
                    
                    const deletePromises = [];
                    snapshot.forEach(doc => {
                        deletePromises.push(doc.ref.delete());
                    });
                    await Promise.all(deletePromises);
                }
                return null;
            });
        });

        await Promise.all(sendPromises);
        console.log('Notifications sent successfully');
        
    } catch (error) {
        console.error('Error in onNewAppointment:', error);
    }
});

/**
 * Cloud Function: נשלח כש-תור מאושר או נדחה
 * Trigger: onUpdate בקולקציה appointments
 */
exports.onAppointmentUpdate = onDocumentUpdated('appointments/{appointmentId}', async (event) => {
    try {
        const beforeData = event.data.before.data();
        const afterData = event.data.after.data();
        const appointmentId = event.params.appointmentId;

        console.log('Appointment updated:', appointmentId);

        // בדיקה אם הסטטוס השתנה מ-pending ל-approved
        if (beforeData.status === 'pending' && afterData.status === 'approved') {
            console.log('Appointment approved, sending notification to customer');

            // כאן אפשר להוסיף לוגיקה לשליחת התראה ללקוחה
            // כרגע זה פשוט לוג, כי לקוחות לא רושמות טוקנים
            // בעתיד אפשר להוסיף SMS או email כאן

            console.log(`Appointment approved: ${afterData.name}, ${afterData.date} ${afterData.time}`);
            
            // TODO: הוסף כאן שליחת SMS דרך Twilio או Email
        }

    } catch (error) {
        console.error('Error in onAppointmentUpdate:', error);
    }
});

/**
 * פונקציית עזר: פורמט תאריך לעברית
 */
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('he-IL', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long' 
    });
}
